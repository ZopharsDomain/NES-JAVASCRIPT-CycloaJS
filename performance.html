<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<script type="text/javascript" src="js/cycloa/cycloa.js"></script>
	<script type="text/javascript" src="js/cycloa/err.js"></script>
	<script type="text/javascript" src="js/cycloa/util.js"></script>
	<script type="text/javascript" src="js/cycloa/fast.js"></script>
	<script type="text/javascript" src="js/cycloa/trace.js"></script>
	<script type="text/javascript" src="test/test_rom.js"></script>
	<script>
		function VideoFairy(){
			this.screen = document.getElementById('screen');
			this.ctx = this.screen.getContext('2d');
			this.image = this.ctx.createImageData(256, 240);
			this.palette = cycloa.NesPalette;
			this.dispatchRendering = function(/* const uint8_t*/ nesBuffer, /* const uint8_t */ paletteMask){
				var dat = this.image.data;
				var palette = this.palette;
				for(var i=0;i<256*240; ++i){
					//TODO: 最適化
					var idx = i << 2, color = palette[nesBuffer[i & paletteMask]];
					dat[idx] = color & 0xff;
					dat[idx+1] = (color >> 8) & 0xff;
					dat[idx+2] = (color >> 16) & 0xff;
					dat[idx+3] = 0xff;
				}
				this.ctx.putImageData(this.image, 0, 0);
			};
		}

		function measurePerformance(){
			var machine = new cycloa.FastMachine(TestROM.buffer, new VideoFairy());
			var tracer = new cycloa.Tracer(machine);
			var start = new Date();
			var clock = 0;
			
			for(var i = 0; i < 1; ++i){
				machine.onHardReset();
				for(var t = 0; t < 50000000; ++t){
					//console.log(tracer.decode());
					clock += machine.run();
				}
			}
			var end = new Date();
			var time = (end-start);
			document.getElementById('console').innerHTML = "nclocks: "+clock+" /time: "+time+"ms / "+(clock/time/1000)+"MHz";
		}
	</script>
	<title>unit test</title>
</head>
<body>
	<input id="start" onclick="measurePerformance();" type="button" value="start" />
	<div id="console"></div>
	<canvas id="screen" width="256" height="240"></canvas>
</body>
</html>
