<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title></title>
	<meta name="description" content="">
	<link rel="stylesheet" href="css/style.css">
	<script type="text/javascript" src="js/cycloa/cycloa.js"></script>
	<script type="text/javascript" src="js/cycloa/trace.js"></script>
	<script type="text/javascript" src="js/cycloa/err.js"></script>
	<script type="text/javascript" src="js/cycloa/util.js"></script>
	<script type="text/javascript" src="js/cycloa/fast.js"></script>
	<script type="text/javascript" src="test/test_rom.js"></script>
	<script>
		function VideoFairy(){
			this.screen = document.getElementById('nes_screen');
			this.ctx = this.screen.getContext('2d');
			this.image = this.ctx.createImageData(256, 240);
			this.palette = cycloa.NesPalette;
			for(var i=0;i<256*240; ++i){
				this.image.data[(i<<2)+3] = 0xff;
			}
			this.dispatchRendering = function(/* const uint8_t*/ nesBuffer, /* const uint8_t */ paletteMask){
				var dat = this.image.data;
				var palette = this.palette;
				for(var i=0;i<256*240; ++i){
					//TODO: 最適化
					var idx = i << 2, color = palette[nesBuffer[i] & paletteMask];
					dat[idx  ] = (color >> 16) & 0xff;
					dat[idx+1] = (color >> 8) & 0xff;
					dat[idx+2] = color & 0xff;
				}
				this.ctx.putImageData(this.image, 0, 0);
			};
		}
		var called = 0;
		function AudioFairy(){
			this.SAMPLE_RATE = 22050;
			this.BUFFER_SIZE = (this.SAMPLE_RATE/4) | 0;
			var context = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;
			if(context){
				this.context = new context();
				this.context.sampleRate = this.SAMPLE_RATE;
				this.index = 0;
				this.initBuffer = function(){
					this.buffer = this.context.createBuffer(1, this.BUFFER_SIZE, this.SAMPLE_RATE);
					this.data = this.buffer.getChannelData(0);
				};
				this.pushAudio = function(audio){
					this.data[this.index++] = audio;
					if(this.index >= this.BUFFER_SIZE){
						var src = this.context.createBufferSource();
						src.loop = false;
						src.connect(this.context.destination);
						src.buffer = this.buffer;
						src.noteOn(0);
						this.initBuffer();
						this.index = 0;
					}
					called++;
				};
				this.initBuffer();
			}else{
				this.pushAudio = function(audio){};
			}
		}
		function PadFairy(){
			this.state = 0;
			this.isPressed = function(keyIdx){
				return ((this.state >> keyIdx) & 1) === 1;
			};
			var self = this;
			window.onkeydown = function(e){
				switch(e.keyCode){
					case 38:
						self.state |= self.MASK_UP;
						e.preventDefault();
						break;
					case 40:
						self.state |= self.MASK_DOWN;
						e.preventDefault();
						break;
					case 37:
						self.state |= self.MASK_LEFT;
						e.preventDefault();
						break;
					case 39:
						self.state |= self.MASK_RIGHT;
						e.preventDefault();
						break;
					case 90:
						self.state |= self.MASK_A;
						e.preventDefault();
						break;
					case 88:
						self.state |= self.MASK_B;
						e.preventDefault();
						break;
					case 32:
						self.state |= self.MASK_SELECT;
						e.preventDefault();
						break;
					case 13:
						self.state |= self.MASK_START;
						e.preventDefault();
						break;
				}
			};
			window.onkeyup = function(e){
				e.preventDefault();
				switch(e.keyCode){
					case 38:
						self.state &= ~self.MASK_UP;
						e.preventDefault();
						break;
					case 40:
						self.state &= ~self.MASK_DOWN;
						e.preventDefault();
						break;
					case 37:
						self.state &= ~self.MASK_LEFT;
						e.preventDefault();
						break;
					case 39:
						self.state &= ~self.MASK_RIGHT;
						e.preventDefault();
						break;
					case 90:
						self.state &= ~self.MASK_A;
						e.preventDefault();
						break;
					case 88:
						self.state &= ~self.MASK_B;
						e.preventDefault();
						break;
					case 32:
						self.state &= ~self.MASK_SELECT;
						e.preventDefault();
						break;
					case 13:
						self.state &= ~self.MASK_START;
						e.preventDefault();
						break;
				}
			};
		}
		PadFairy.prototype = new cycloa.AbstractPadFairy();
		function start(arrayBuffer){
			var machine = new cycloa.FastMachine(arrayBuffer, new VideoFairy(), new AudioFairy(), new PadFairy());
			machine.onHardReset();
			var beg = new Date();
			var cnt = 0;
			var fps = document.getElementById("fps");
			var frame = function(){
				machine.run();
				cnt++;
				if(cnt == 30) {
					var now = new Date();
					fps.innerHTML = "fps: "+(30000/(now-beg))+" / called: "+(called*2);
					called = 0;
					beg = now;
					cnt = 0;
				}
			};
			window.setInterval(frame, 16);
		}
		function loadFile(file){
			var reader = new FileReader();
			reader.onload = function(rom){
				start(rom.target.result);
			};
			reader.readAsArrayBuffer(file);
		}
		function load(){
			window.addEventListener("dragenter", function (e) { e.preventDefault(); }, false);
			window.addEventListener("dragover", function (e) { e.preventDefault(); }, false);
			window.addEventListener("drop", function (e) { e.preventDefault(); loadFile(e.dataTransfer.files[0]); }, false);
		}
	</script>
</head>
<body onload="load()">
	<div id="wrapper">
		<div id="header">
		</div>
		<div id="content">
			<div>
				<canvas id="nes_screen" width="256" height="240"></canvas>
				<div id="fps"></div>
			</div>
			<input type="button" onclick="start(TestROM.buffer)" value="Load TEST ROM" />
		</div>
		<div id="footer">
		2012 (C)PSI GPLv3 or later
		</div>
	</div>
</body>
</html>
