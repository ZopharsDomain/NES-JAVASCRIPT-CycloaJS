<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title></title>
	<meta name="description" content="">
	<link rel="stylesheet" href="css/style.css">
	<script type="text/javascript" src="js/cycloa/cycloa.js"></script>
	<script type="text/javascript" src="js/cycloa/trace.js"></script>
	<script type="text/javascript" src="js/cycloa/err.js"></script>
	<script type="text/javascript" src="js/cycloa/util.js"></script>
	<script type="text/javascript" src="js/cycloa/fast.js"></script>
	<script type="text/javascript" src="test/test_rom.js"></script>
	<script>
		// http://paulirish.com/2011/requestanimationframe-for-smart-animating/
		window.requestAnimFrame = (function () {
			return  window.requestAnimationFrame ||
					window.webkitRequestAnimationFrame ||
					window.mozRequestAnimationFrame ||
					window.oRequestAnimationFrame ||
					window.msRequestAnimationFrame ||
					function (callback) {
						window.setTimeout(callback, 1000 / 60);
					};
		})();
		function VideoFairy() {
			this.screen = document.getElementById('nes_screen');
			this.ctx = this.screen.getContext('2d');
			this.image = this.ctx.createImageData(256, 240);
			this.palette = cycloa.NesPalette;
			this.prevBuffer = new Uint8Array(256*240);
			for (var i = 0; i < 256 * 240; ++i) {
				this.image.data[(i << 2) + 3] = 0xff;
			}
			this.dispatchRendering = function (/* const uint8_t*/ nesBuffer, /* const uint8_t */ paletteMask) {
				var dat = this.image.data;
				var palette = this.palette;
				var prevBuffer = this.prevBuffer;
				var pixel;
				for (var i = 0; i < 61440 /* = 256*240 */; ++i) {
					//TODO: 最適化
					pixel = nesBuffer[i] & paletteMask;
					if(pixel != prevBuffer[i]){
						var idx = i << 2, color = palette[pixel];
						dat[idx    ] = (color >> 16) & 0xff;
						dat[idx + 1] = (color >> 8) & 0xff;
						dat[idx + 2] = color & 0xff;
						prevBuffer[i] = pixel;
					}
				}
				this.ctx.putImageData(this.image, 0, 0);
			};
		}
		function AudioFairy() {
			this.SAMPLE_RATE_ = 22050;
			this.dataLength = (this.SAMPLE_RATE_ / 4) | 0;
			this.enabled = false;
			var context = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;
			if (context) {
				this.enabled = true;
				this.context_ = new context();
				this.context_.sampleRate = this.SAMPLE_RATE_;
				this.dataIndex = 0;
				this.initBuffer = function () {
					this.buffer_ = this.context_.createBuffer(1, this.dataLength, this.SAMPLE_RATE_);
					this.data = this.buffer_.getChannelData(0);
				};
				this.onDataFilled = function () {
					var src = this.context_.createBufferSource();
					src.loop = false;
					src.connect(this.context_.destination);
					src.buffer = this.buffer_;
					src.noteOn(0);
					this.initBuffer();
					this.dataIndex = 0;
				};
				this.initBuffer();
			}
		}
		function PadFairy() {
			this.state = 0;
			var self = this;
			window.onkeydown = function (e) {
				switch (e.keyCode) {
					case 38:
						self.state |= self.MASK_UP;
						e.preventDefault();
						break;
					case 40:
						self.state |= self.MASK_DOWN;
						e.preventDefault();
						break;
					case 37:
						self.state |= self.MASK_LEFT;
						e.preventDefault();
						break;
					case 39:
						self.state |= self.MASK_RIGHT;
						e.preventDefault();
						break;
					case 90:
						self.state |= self.MASK_A;
						e.preventDefault();
						break;
					case 88:
						self.state |= self.MASK_B;
						e.preventDefault();
						break;
					case 32:
						self.state |= self.MASK_SELECT;
						e.preventDefault();
						break;
					case 13:
						self.state |= self.MASK_START;
						e.preventDefault();
						break;
				}
			};
			window.onkeyup = function (e) {
				e.preventDefault();
				switch (e.keyCode) {
					case 38:
						self.state &= ~self.MASK_UP;
						e.preventDefault();
						break;
					case 40:
						self.state &= ~self.MASK_DOWN;
						e.preventDefault();
						break;
					case 37:
						self.state &= ~self.MASK_LEFT;
						e.preventDefault();
						break;
					case 39:
						self.state &= ~self.MASK_RIGHT;
						e.preventDefault();
						break;
					case 90:
						self.state &= ~self.MASK_A;
						e.preventDefault();
						break;
					case 88:
						self.state &= ~self.MASK_B;
						e.preventDefault();
						break;
					case 32:
						self.state &= ~self.MASK_SELECT;
						e.preventDefault();
						break;
					case 13:
						self.state &= ~self.MASK_START;
						e.preventDefault();
						break;
				}
			};
		}
		PadFairy.prototype = new cycloa.AbstractPadFairy();
		function start(arrayBuffer) {
			var machine = new cycloa.FastMachine(arrayBuffer, new VideoFairy(), new AudioFairy(), new PadFairy());
			machine.onHardReset();
			var beg = new Date();
			var cnt = 0;
			var fps = document.getElementById("fps");
			var loop = function () {
				//window.requestAnimFrame(loop);
				machine.run();
				cnt++;
				if (cnt == 30) {
					var now = new Date();
					fps.innerHTML = "fps: " + (30000 / (now - beg));
					beg = now;
					cnt = 0;
				}
			};
			//loop();
			window.setInterval(loop, 1000/60);
		}
		function loadFile(file) {
			var reader = new FileReader();
			reader.onload = function (rom) {
				start(rom.target.result);
			};
			reader.readAsArrayBuffer(file);
		}
		function load() {
			window.addEventListener("dragenter", function (e) {
				e.preventDefault();
			}, false);
			window.addEventListener("dragover", function (e) {
				e.preventDefault();
			}, false);
			window.addEventListener("drop", function (e) {
				e.preventDefault();
				loadFile(e.dataTransfer.files[0]);
			}, false);
		}
	</script>
</head>
<body onload="load()">
<div id="wrapper">
	<div id="header">
	</div>
	<div id="content">
		<div>
			<canvas id="nes_screen" width="256" height="240"></canvas>
			<div id="fps"></div>
		</div>
		<input type="button" onclick="start(TestROM.buffer)" value="Load TEST ROM"/>
	</div>
	<div id="footer">
		2012 (C)PSI GPLv3 or later
	</div>
</div>
</body>
</html>
