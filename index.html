<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title></title>
	<meta name="description" content="">
	<link rel="stylesheet" href="css/style.css">
	<script type="text/javascript" src="js/cycloa.js"></script>
	<script type="text/javascript" src="js/trace.js"></script>
	<script type="text/javascript" src="js/err.js"></script>
	<script type="text/javascript" src="js/util.js"></script>
	<script type="text/javascript" src="js/default_fairy.js"></script>
	<script type="text/javascript" src="js/fast.js"></script>
	<script type="text/javascript" src="js/fast.js"></script>
	<script type="text/javascript">
		function start(arrayBuffer) {
			var machine = new cycloa.FastMachine(arrayBuffer, new VideoFairy(), new AudioFairy(), new PadFairy());
			machine.onHardReset();
			var cnt = 0;
			var fps = document.getElementById("fps");
			var loop = function () {
				//window.requestAnimFrame(loop);
				window.setTimeout(loop,  16);
				machine.run();
				cnt++;
				if (cnt >= 30) {
					var now = new Date();
					fps.innerHTML = "fps: " + (cnt * 1000 / (now - beg));
					beg = now;
					cnt = 0;
				}
			};
			var beg = new Date();
			loop();
			/*
			var beg = new Date();
			for(var i=0;i<600;++i){
				machine.run();
			}
			var now = new Date();
			fps.innerHTML = "fps: " + (i * 1000 / (now - beg));
			*/
		}
		function loadFile(file) {
			var reader = new FileReader();
			reader.onload = function (rom) {
				start(rom.target.result);
			};
			reader.readAsArrayBuffer(file);
		}
		function load() {
			window.addEventListener("dragenter", function (e) {
				e.preventDefault();
			}, false);
			window.addEventListener("dragover", function (e) {
				e.preventDefault();
			}, false);
			window.addEventListener("drop", function (e) {
				e.preventDefault();
				loadFile(e.dataTransfer.files[0]);
			}, false);
		}
	</script>
</head>
<body onload="load()">
<div id="wrapper">
	<div id="header">
	</div>
	<div id="content">
		<div>
			<canvas id="nes_screen" width="256" height="240"></canvas>
			<div id="fps"></div>
		</div>
		<input type="button" onclick="start(TestROM.buffer)" value="Load TEST ROM"/>
	</div>
	<div id="footer">
		2012 (C)PSI GPLv3 or later
	</div>
</div>
</body>
</html>
