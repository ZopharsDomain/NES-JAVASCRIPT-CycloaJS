<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title></title>
	<meta name="description" content="">
	<link rel="stylesheet" href="css/style.css">
	<script type="text/javascript" src="js/cycloa/cycloa.js"></script>
	<script type="text/javascript" src="js/cycloa/err.js"></script>
	<script type="text/javascript" src="js/cycloa/util.js"></script>
	<script type="text/javascript" src="js/cycloa/fast.js"></script>
	<script type="text/javascript" src="js/cycloa/trace.js"></script>
	<script type="text/javascript" src="test/test_rom.js"></script>
	<script>
		function VideoFairy(){
			this.screen = document.getElementById('nes_screen');
			this.ctx = this.screen.getContext('2d');
			this.image = this.ctx.createImageData(256, 240);
			this.palette = cycloa.NesPalette;
			for(var i=0;i<256*240; ++i){
				this.image.data[(i<<2)+3] = 0xff;
			}
			this.dispatchRendering = function(/* const uint8_t*/ nesBuffer, /* const uint8_t */ paletteMask){
				var dat = this.image.data;
				var palette = this.palette;
				for(var i=0;i<256*240; ++i){
					//TODO: 最適化
					var idx = i << 2, color = palette[nesBuffer[i] & paletteMask];
					dat[idx  ] = (color >> 16) & 0xff;
					dat[idx+1] = (color >> 8) & 0xff;
					dat[idx+2] = color & 0xff;
				}
				this.ctx.putImageData(this.image, 0, 0);
			};
		}
		function start(arrayBuffer){
			var machine = new cycloa.FastMachine(arrayBuffer, new VideoFairy());
			machine.onHardReset();
			var beg = new Date();
			var cnt = 0;
			var fps = document.getElementById("fps");
			var frame = function(){
				machine.run();
				cnt++;
				if(cnt == 30){
					var now = new Date();
					fps.innerHTML = "fps: "+(30000/(now-beg));
					beg = now;
					cnt = 0;
				}
			};
			window.setInterval(frame, 16);
		}
		function loadFile(file){
			var reader = new FileReader();
			reader.onload = function(rom){
				start(rom.target.result);
			};
			reader.readAsArrayBuffer(file);
		}
		function load(){
			window.addEventListener("dragenter", function (e) { e.preventDefault(); }, false);
			window.addEventListener("dragover", function (e) { e.preventDefault(); }, false);
			window.addEventListener("drop", function (e) { e.preventDefault(); loadFile(e.dataTransfer.files[0]); }, false);
		}
	</script>
</head>
<body onload="load()">
	<div id="wrapper">
		<div id="header">
		</div>
		<div id="content">
			<div>
				<canvas id="nes_screen" width="256" height="240"></canvas>
				<div id="fps"></div>
			</div>
			<input type="button" onclick="start(TestROM.buffer)" value="Load TEST ROM" />
		</div>
		<div id="footer">
		2012 (C)PSI GPLv3 or later
		</div>
	</div>
</body>
</html>
